<!DOCTYPE html>
<html lang="en">


<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Zend Framework Tutorials">  
    <link rel="shortcut icon" href="../../img/favicon.ico">

    <title>SQL Abstraction and Object Hydration - tutorials</title>

    <link rel="stylesheet" href="../../css/styles-e3f3751b65.css">
</head>
<body id="page-top">

    
    <div class="navbar navbar-default" role="navigation">
    <div class="container">
        <div class="navbar-header">

            
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            
            <span class="navbar-brand">
                <a class="logo-link" href="https://framework.zend.com/" data-tooltip data-placement="bottom" title="Go to the ZF homepage">
                    <img src="../../img/zend-framework-logo.svg" height="28" alt="Zend Framework">
                </a>
            </span>
        </div>

        <div class="navbar-collapse collapse">

            
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="https://framework.zend.com/about">About</a>
                </li>
                <li>
                    <a href="https://framework.zend.com/downloads">Install</a>
                </li>
                <li class="active">
                    <a href="https://docs.zendframework.com">Documentation</a>
                </li>
                <li>
                    <a href="https://www.zend.com/en/services/training">Training</a>
                </li>
                <li>
                    <a href="https://framework.zend.com/blog">Blog</a>
                </li>
                <li>
                    <a href="https://framework.zend.com/participate">Participate</a>
                </li>
            </ul>

            
            
                <div class="nav navbar-nav navbar-collapse visible-xs-block ">
                    <div class="subnavigation hidden-print">
    <h4 class="subnavigation__title">
        <a href="../..">tutorials</a>
    </h4>

    <h5 class="subnavigation__subtitle">Table of Contents</h5>

    <ul class="subnavigation__list">
        
            
                <li class="subnavigation__list-item ">
                    <a href="../.." class="subnavigation__link">Tutorials for Zend Framework</a>
                </li>
            
        
            
                <li class="subnavigation__list-item">
                    <span class="subnavigation__headline">MVC Tutorials</span>
                    <ul class="subnavigation__list">
                        
                            
    <li class="subnavigation__list-item">
        <span class="subnavigation__headline">Getting Started with Zend Framework</span>
        <ul class="subnavigation__list">
            
                
    <li class="subnavigation__list-item ">
        <a href="../../getting-started/overview/" class="subnavigation__link">Overview</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../../getting-started/skeleton-application/" class="subnavigation__link">The Skeleton Application</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../../getting-started/modules/" class="subnavigation__link">Modules</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../../getting-started/routing-and-controllers/" class="subnavigation__link">Routing and Controllers</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../../getting-started/database-and-models/" class="subnavigation__link">Database and Models</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../../getting-started/forms-and-actions/" class="subnavigation__link">Forms and Actions</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../../getting-started/conclusion/" class="subnavigation__link">Conclusion</a>
    </li>

            
        </ul>
    </li>

                        
                            
    <li class="subnavigation__list-item ">
        <a href="../../unit-testing/" class="subnavigation__link">Unit Testing A zend-mvc Application</a>
    </li>

                        
                            
    <li class="subnavigation__list-item ">
        <a href="../../navigation/" class="subnavigation__link">Adding zend-navigation to the Album Module</a>
    </li>

                        
                            
    <li class="subnavigation__list-item ">
        <a href="../../pagination/" class="subnavigation__link">Adding zend-paginator to the Album Module</a>
    </li>

                        
                            
    <li class="subnavigation__list-item">
        <span class="subnavigation__headline">In-Depth Tutorial</span>
        <ul class="subnavigation__list">
            
                
    <li class="subnavigation__list-item ">
        <a href="../first-module/" class="subnavigation__link">Introducing the Blog Module</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../models-and-servicemanager/" class="subnavigation__link">Models and the ServiceManager</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../preparing-databases/" class="subnavigation__link">Preparing for Different Databases</a>
    </li>

            
                
    <li class="subnavigation__list-item subnavigation__list-item--active">
        <a href="./" class="subnavigation__link">SQL Abstraction and Object Hydration</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../understanding-routing/" class="subnavigation__link">Understanding the Router</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../zend-form-zend-form-fieldset/" class="subnavigation__link">Making Use of Forms and Fieldsets</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../data-binding/" class="subnavigation__link">Editing and Deleting Data</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../review/" class="subnavigation__link">Reviewing the Blog Module</a>
    </li>

            
        </ul>
    </li>

                        
                            
    <li class="subnavigation__list-item ">
        <a href="../../advanced-config/" class="subnavigation__link">Advanced Configuration</a>
    </li>

                        
                            
    <li class="subnavigation__list-item ">
        <a href="../../i18n/" class="subnavigation__link">Internationalization</a>
    </li>

                        
                    </ul>
                </li>
            
        
            
                <li class="subnavigation__list-item">
                    <span class="subnavigation__headline">Component Tutorials</span>
                    <ul class="subnavigation__list">
                        
                            
    <li class="subnavigation__list-item ">
        <a href="../../db-adapter/" class="subnavigation__link">Setting Up A Database Adapter</a>
    </li>

                        
                            
    <li class="subnavigation__list-item ">
        <a href="../../event-manager/" class="subnavigation__link">Using the EventManager</a>
    </li>

                        
                    </ul>
                </li>
            
        
            
                <li class="subnavigation__list-item">
                    <span class="subnavigation__headline">Migration</span>
                    <ul class="subnavigation__list">
                        
                            
    <li class="subnavigation__list-item">
        <span class="subnavigation__headline">To Version 3</span>
        <ul class="subnavigation__list">
            
                
    <li class="subnavigation__list-item ">
        <a href="../../migration/to-v3/overview/" class="subnavigation__link">Overview</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../../migration/to-v3/components/" class="subnavigation__link">Components</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../../migration/to-v3/application/" class="subnavigation__link">Applications</a>
    </li>

            
        </ul>
    </li>

                        
                    </ul>
                </li>
            
        
    </ul>
</div>
                </div>
            

            
            <div class="nav navbar-nav navbar-collapse visible-xs-block">
                <div class="component-selector">
    <h4 class="component-selector__title">Components</h4>
    <h5 class="component-selector__subtitle">Find documentation…</h5>
    <select class="form-control component-selector__control">
        <option value="/">Overview</option>
        <optgroup label="Components"></optgroup>
    </select>
</div>
            </div>
        </div>
    </div>
</div>

    
    <header class="header">
    <div class="container">
        <div class="row">

            
            <div class="col-xs-8">
                <h1 class="header__title">
                    Documentation

                    
                        <small class="header__subtitle">tutorials</small>
                    
                </h1>
            </div>

            
            <div class="col-xs-4 text-right">
                
                    <a href="#" class="header__link header__link--search" data-toggle="modal" data-target="#mkdocs_search_modal" title="Open search">
                        <i class="fa fa-search"></i> Search
                    </a>
                    <a href="https://github.com/zendframework/tutorials/" class="header__link header__link--github" title="Go to repository of tutorials">
                        <i class="fa fa-github"></i> GitHub
                    </a>
                
            </div>
        </div>
    </div>
</header>

    
    <div class="container">
        <div class="row">
            <div class="col-md-9 col-xs-12 content" role="main">
            <!-- content:begin -->
                
                    <ol class="breadcrumb" role="navigation" aria-label="breadcrumbs navigation">
  <li><a href="https://framework.zend.com/">Home</a></li>
  <li><a href="https://docs.zendframework.com/">Docs</a></li>
  <li><a href="../..">tutorials</a></li>
  
    
      
        <li>MVC Tutorials</li>
      
    
      
        <li>In-Depth Tutorial</li>
      
    
  
  <li class="active">SQL Abstraction and Object Hydration</li>
</ol>


    
    

    
    
        <div class="toc">
            <h6 class="toc__headline">In This Article</h6>
            <ul class="toc__list">
                
                    <li class="toc__entry">
                        <a href="#preparing-the-database" class="toc__link">Preparing the Database</a>
                    </li>
                
                    <li class="toc__entry">
                        <a href="#quick-facts-zend92db92sql" class="toc__link">Quick Facts Zend\Db\Sql</a>
                    </li>
                
                    <li class="toc__entry">
                        <a href="#writing-the-repository-implementation" class="toc__link">Writing the repository implementation</a>
                    </li>
                
                    <li class="toc__entry">
                        <a href="#refactoring-hidden-dependencies" class="toc__link">Refactoring hidden dependencies</a>
                    </li>
                
                    <li class="toc__entry">
                        <a href="#finishing-the-repository" class="toc__link">Finishing the repository</a>
                    </li>
                
                    <li class="toc__entry">
                        <a href="#conclusion" class="toc__link">Conclusion</a>
                    </li>
                
            </ul>
        </div>
    


    <h1 id="sql-abstraction-and-object-hydration">SQL Abstraction and Object Hydration</h1>
<p>In the last chapter, we introduced database abstraction and a new command
interface for operations that might change what blog posts we store. We'll now
start creating database-backed versions of the <code>PostRepositoryInterface</code> and
<code>PostCommandInterface</code>, demonstrating usage of the various <code>Zend\Db\Sql</code>
classes.</p>
<h2 id="preparing-the-database">Preparing the Database</h2>
<p>This tutorial assumes you've followed the <a href="../../getting-started/overview/">Getting Started</a>
tutorial, and that you've already populated the <code>data/zftutorial.db</code> SQLite
database. We will be re-using it, and adding another table to it.</p>
<p>Create the file <code>data/posts.schema.sql</code> with the following contents:</p>
<pre class="codehilite"><code class="language-sql">CREATE TABLE posts (id INTEGER PRIMARY KEY AUTOINCREMENT, title varchar(100) NOT NULL, text TEXT NOT NULL);

INSERT INTO posts (title, text) VALUES ('Blog #1', 'Welcome to my first blog post');
INSERT INTO posts (title, text) VALUES ('Blog #2', 'Welcome to my second blog post');
INSERT INTO posts (title, text) VALUES ('Blog #3', 'Welcome to my third blog post');
INSERT INTO posts (title, text) VALUES ('Blog #4', 'Welcome to my fourth blog post');
INSERT INTO posts (title, text) VALUES ('Blog #5', 'Welcome to my fifth blog post');</code></pre>

<p>Now we will execute this against the existing <code>data/zftutorial.db</code> SQLite
database using the <code>sqlite</code> command (or <code>sqlite3</code>; check your operating system):</p>
<pre class="codehilite"><code class="language-bash">$ sqlite data/zftutorial.db &lt; data/posts.schema.sql</code></pre>

<p>If you don't have a <code>sqlite</code> command, you can populate it using PHP. Create the
following script in <code>data/load_posts.php</code>:</p>
<pre class="codehilite"><code class="language-php">&lt;?php
$db = new PDO('sqlite:' . __DIR__ . '/zftutorial.db');
$fh = fopen(__DIR__ . '/posts.schema.sql', 'r');
while ($line = fread($fh, 4096)) {
    $line = trim($line);
    $db-&gt;exec($line);
}
fclose($fh);</code></pre>

<p>and execute it using:</p>
<pre class="codehilite"><code class="language-bash">$ php data/load_posts.php</code></pre>

<h2 id="quick-facts-zend92db92sql">Quick Facts Zend\Db\Sql</h2>
<p>To create queries against a database using <code>Zend\Db\Sql</code>, you need to have a
database adapter available. The "Getting Started" tutorial
<a href="../../getting-started/database-and-models/#using-servicemanager-to-configure-the-table-gateway-and-inject-into-the-albumtable">covered this in the database chapter</a>,
and we can re-use that adapter.</p>
<p>With the adapter in place and the new table populated, we can run queries
against the database. The construction of queries is best done through the
"QueryBuilder" features of <code>Zend\Db\Sql</code> which are <code>Zend\Db\Sql\Sql</code> for select
queries, <code>Zend\Db\Sql\Insert</code> for insert queries, <code>Zend\Db\Sql\Update</code> for
update queries and <code>Zend\Db\Sql\Delete</code> for delete queries. The basic workflow
of these components is:</p>
<ol>
<li>Build a query using the relevant class: <code>Sql</code>, <code>Insert</code>, <code>Update</code>, or
   <code>Delete</code>.</li>
<li>Create a SQL statement from the <code>Sql</code> object.</li>
<li>Execute the query.</li>
<li>Do something with the result.</li>
</ol>
<p>Let's start writing database-driven implementations of our interfaces now.</p>
<h2 id="writing-the-repository-implementation">Writing the repository implementation</h2>
<p>Create a class named <code>ZendDbSqlRepository</code> in the <code>Blog\Model</code> namespace that
implements <code>PostRepositoryInterface</code>; leave the methods empty for now:</p>
<pre class="codehilite"><code class="language-php">// In module/Blog/src/Model/ZendDbSqlRepository.php:
namespace Blog\Model;

use InvalidArgumentException;
use RuntimeException;

class ZendDbSqlRepository implements PostRepositoryInterface
{
    /**
     * {@inheritDoc}
     */
    public function findAllPosts()
    {
    }

    /**
     * {@inheritDoc}
     * @throws InvalidArgumentException
     * @throws RuntimeException
     */
    public function findPost($id)
    {
    }
}</code></pre>

<p>Now recall what we have learned earlier: for <code>Zend\Db\Sql</code> to function, we will
need a working implementation of the <code>AdapterInterface</code>. This is a
<em>requirement</em>, and therefore will be injected using <em>constructor injection</em>.
Create a <code>__construct()</code> method that accepts an <code>AdapterInterface</code> as its sole
parameter, and stores it as an instance property:</p>
<pre class="codehilite"><code class="language-php">// In module/Blog/src/Model/ZendDbSqlRepository.php:
namespace Blog\Model;

use InvalidArgumentException;
use RuntimeException;
use Zend\Db\Adapter\AdapterInterface;

class ZendDbSqlRepository implements PostRepositoryInterface
{
    /**
     * @var AdapterInterface
     */
    private $db;

    /**
     * @param AdapterInterface $db
     */
    public function __construct(AdapterInterface $db)
    {
        $this-&gt;db = $db;
    }

    /**
     * {@inheritDoc}
     */
    public function findAllPosts()
    {
    }

    /**
     * {@inheritDoc}
     * @throws InvalidArgumentException
     * @throws RuntimeException
     */
    public function findPost($id)
    {
    }
}</code></pre>

<p>Whenever we have a required parameter, we need to write a factory for the class.
Go ahead and create a factory for our new repository implementation:</p>
<pre class="codehilite"><code class="language-php">// In module/Blog/src/Factory/ZendDbSqlRepositoryFactory.php
namespace Blog\Factory;

use Interop\Container\ContainerInterface;
use Blog\Model\ZendDbSqlRepository;
use Zend\Db\Adapter\AdapterInterface;
use Zend\ServiceManager\Factory\FactoryInterface;

class ZendDbSqlRepositoryFactory implements FactoryInterface
{
    /**
     * @param ContainerInterface $container
     * @param string $requestedName
     * @param null|array $options
     * @return ZendDbSqlRepository
     */
    public function __invoke(ContainerInterface $container, $requestedName, array $options = null)
    {
        return new ZendDbSqlRepository($container-&gt;get(AdapterInterface::class));
    }
}</code></pre>

<p>We're now able to register our repository implementation as a service. To do so,
we'll make two changes:</p>
<ul>
<li>Register a factory entry for the new repository.</li>
<li>Update the existing alias for <code>PostRepositoryInterface</code> to point to the new
  repository.</li>
</ul>
<p>Update <code>module/Blog/config/module.config.php</code> as follows:</p>
<pre class="codehilite"><code class="language-php">return [
    'service_manager' =&gt; [
        'aliases' =&gt; [
            // Update this line:
            Model\PostRepositoryInterface::class =&gt; Model\ZendDbSqlRepository::class,
        ],
        'factories' =&gt; [
            Model\PostRepository::class =&gt; InvokableFactory::class,
            // Add this line:
            Model\ZendDbSqlRepository::class =&gt; Factory\ZendDbSqlRepositoryFactory::class,
        ],
    ],
    'controllers'  =&gt; [ /* ... */ ],
    'router'       =&gt; [ /* ... */ ],
    'view_manager' =&gt; [ /* ... */ ],
];</code></pre>

<p>With the adapter in place you're now able to refresh the blog index at
<code>localhost:8080/blog</code> and you'll notice that the <code>ServiceNotFoundException</code> is
gone and we get the following PHP Warning:</p>
<pre class="codehilite"><code class="language-text">Warning: Invalid argument supplied for foreach() in {projectPath}/module/Blog/view/blog/list/index.phtml on line {lineNumber}</code></pre>

<p>This is due to the fact that our mapper doesn't return anything yet. Let's
modify the <code>findAllPosts()</code> function to return all blog posts from the database
table:</p>
<pre class="codehilite"><code class="language-php">// In /module/Blog/src/Model/ZendDbSqlRepository.php:
namespace Blog\Model;

use InvalidArgumentException;
use RuntimeException;
use Zend\Db\Adapter\AdapterInterface;
use Zend\Db\Sql\Sql;

class ZendDbSqlRepository implements PostRepositoryInterface
{
    /**
     * @var AdapterInterface
     */
    private $db;

    /**
     * @param AdapterInterface $db
     */
    public function __construct(AdapterInterface $db)
    {
        $this-&gt;db = $db;
    }

    /**
     * {@inheritDoc}
     */
    public function findAllPosts()
    {
        $sql    = new Sql($this-&gt;db);
        $select = $sql-&gt;select('posts');
        $stmt   = $sql-&gt;prepareStatementForSqlObject($select);
        $result = $stmt-&gt;execute();
        return $result;
    }

    /**
     * {@inheritDoc}
     * @throws InvalidArgumentException
     * @throw RuntimeException
     */
    public function findPost($id)
    {
    }
}</code></pre>

<p>Sadly, though, a refresh of the application reveals another error message:</p>
<pre class="codehilite"><code class="language-text">PHP Fatal error:  Call to a member function getId() on array in {projectPath}/module/Blog/view/blog/list/index.phtml on line {lineNumber}</code></pre>

<p>Let's not return the <code>$result</code> variable for now and do a dump of it to see what
we get here. Change the <code>findAllPosts()</code> method and dump the result:</p>
<pre class="codehilite"><code class="language-php">public function findAllPosts()
{
    $sql    = new Sql($this-&gt;db);
    $select = $sql-&gt;select('posts');
    $stmt   = $sql-&gt;prepareStatementForSqlObject($select);
    $result = $stmt-&gt;execute();

    var_export($result);
    die();

    return $result;
}</code></pre>

<p>Refreshing the application you should now see output similar to the following:</p>
<pre class="codehilite"><code class="language-text">Zend\Db\Adapter\Driver\Pdo\Result::__set_state(array(
    'statementMode'   =&gt; 'forward',
    'fetchMode'       =&gt; 2,
    'resource'        =&gt; PDOStatement::__set_state(array(
        'queryString' =&gt; 'SELECT &quot;posts&quot;.* FROM &quot;posts&quot;',
    )),
    'options'         =&gt; null,
    'currentComplete' =&gt; false,
    'currentData'     =&gt; null,
    'position'        =&gt; -1,
    'generatedValue'  =&gt; '0',
    'rowCount'        =&gt; Closure::__set_state(array()),
))</code></pre>

<p>As you can see, we do not get any data returned. Instead we are presented with a
dump of some <code>Result</code> object that appears to have no data in it whatsoever. But
this is a faulty assumption. This <code>Result</code> object only has information available
for you when you actually try to access it. If you can determine that the query
was successful, the best way to make use of the data within the <code>Result</code> object
is to pass it to a <code>ResultSet</code> object.</p>
<p>First, add two more import statements to the class file:</p>
<pre class="codehilite"><code class="language-php">use Zend\Db\Adapter\Driver\ResultInterface;
use Zend\Db\ResultSet\ResultSet;</code></pre>

<p>Now update the <code>findAllPosts()</code> method as follows:</p>
<pre class="codehilite"><code class="language-php">public function findAllPosts()
{
    $sql    = new Sql($this-&gt;db);
    $select = $sql-&gt;select('posts');
    $stmt   = $sql-&gt;prepareStatementForSqlObject($select);
    $result = $stmt-&gt;execute();

    if ($result instanceof ResultInterface &amp;&amp; $result-&gt;isQueryResult()) {
        $resultSet = new ResultSet();
        $resultSet-&gt;initialize($result);
        var_export($resultSet);
        die();
    }

    die('no data');
}</code></pre>

<p>Refreshing the page, you should now see the dump of a <code>ResultSet</code> instance:</p>
<pre class="codehilite"><code class="language-text">Zend\Db\ResultSet\ResultSet::__set_state(array(
    'allowedReturnTypes'   =&gt;
        array(
            0 =&gt; 'arrayobject',
            1 =&gt; 'array',
        ),
    'arrayObjectPrototype' =&gt;
        ArrayObject::__set_state(array(
        )),
    'returnType'           =&gt; 'arrayobject',
    'buffer'               =&gt; null,
    'count'                =&gt; null,
    'dataSource'           =&gt;
        Zend\Db\Adapter\Driver\Pdo\Result::__set_state(array(
            'statementMode'   =&gt; 'forward',
            'fetchMode'       =&gt; 2,
            'resource'        =&gt;
                PDOStatement::__set_state(array(
                    'queryString' =&gt; 'SELECT &quot;album&quot;.* FROM &quot;album&quot;',
                )),
            'options'         =&gt; null,
            'currentComplete' =&gt; false,
            'currentData'     =&gt; null,
            'position'        =&gt; -1,
            'generatedValue'  =&gt; '0',
            'rowCount'        =&gt;
                Closure::__set_state(array(
                )),
        )),
    'fieldCount'           =&gt; 3,
    'position'             =&gt; 0,
))</code></pre>

<p>Of particular interest is the <code>returnType</code> property, which has a value of
<code>arrayobject</code>.  This tells us that all database entries will be returned as an
<code>ArrayObject</code> instances. And this is a little problem for us, as the
<code>PostRepositoryInterface</code> requires us to return an array of <code>Post</code> instances.
Luckily the <code>Zend\Db\ResultSet</code> subcomponent offers a solution for us, via the
<code>HydratingResultSet</code>; this result set type will populate an object of a type we
specify with the data returned.</p>
<p>Let's modify our code. First, remove the following import statement from the
class file:</p>
<pre class="codehilite"><code class="language-php">use Zend\Db\ResultSet\ResultSet;</code></pre>

<p>Next, we'll add the following import statements to our class file:</p>
<pre class="codehilite"><code class="language-php">use Zend\Hydrator\Reflection as ReflectionHydrator;
use Zend\Db\ResultSet\HydratingResultSet;</code></pre>

<p>Now, update the <code>findAllPosts()</code> method to read as follows:</p>
<pre class="codehilite"><code class="language-php">public function findAllPosts()
{
    $sql       = new Sql($this-&gt;db);
    $select    = $sql-&gt;select('posts');
    $statement = $sql-&gt;prepareStatementForSqlObject($select);
    $result    = $statement-&gt;execute();

    if (! $result instanceof ResultInterface || ! $result-&gt;isQueryResult()) {
        return [];
    }

    $resultSet = new HydratingResultSet(
        new ReflectionHydrator(),
        new Post('', '')
    );
    $resultSet-&gt;initialize($result);
    return $resultSet;
}</code></pre>

<p>We have changed a couple of things here. First, instead of a normal <code>ResultSet</code>,
we are now using the <code>HydratingResultSet</code>. This specialized result set requires two parameters, the
second one being an object to hydrate with data, and the first one being the
<code>hydrator</code> that will be used (a <code>hydrator</code> is an object that will transform an
array of data into an object, and vice versa). We use <code>Zend\Hydrator\Reflection</code>
here, which is capable of injecting private properties of an instance. We
provide an empty <code>Post</code> instance, which the hydrator will clone to create new
instances with data from individual rows.</p>
<p>Instead of dumping the <code>$result</code> variable, we now directly return the
initialized <code>HydratingResultSet</code> so we can access the data stored within. In
case we get something else returned that is not an instance of a
<code>ResultInterface</code>, we return an empty array.</p>
<p>Refreshing the page you will now see all your blog posts listed on the page. Great!</p>
<h2 id="refactoring-hidden-dependencies">Refactoring hidden dependencies</h2>
<p>There's one little thing that we have done that's not a best-practice. We use
both a hydrator and an <code>Post</code> prototype inside our <code>ZendDbSqlRepository</code>. Let's
inject those instead, so that we can reuse them between our repository and
command implementations, or vary them based on environment. Update your
<code>ZendDbSqlRepository</code> as follows:</p>
<pre class="codehilite"><code class="language-php">// In module/Blog/src/Model/ZendDbSqlRepository.php:
namespace Blog\Model;

use InvalidArgumentException;
use RuntimeException;
// Replace the import of the Reflection hydrator with this:
use Zend\Hydrator\HydratorInterface;
use Zend\Db\Adapter\AdapterInterface;
use Zend\Db\Adapter\Driver\ResultInterface;
use Zend\Db\ResultSet\HydratingResultSet;
use Zend\Db\Sql\Sql;

class ZendDbSqlRepository implements PostRepositoryInterface
{
    /**
     * @var AdapterInterface
     */
    private $db;

    /**
     * @var HydratorInterface
     */
    private $hydrator;

    /**
     * @var Post
     */
    private $postPrototype;

    public function __construct(
        AdapterInterface $db,
        HydratorInterface $hydrator,
        Post $postPrototype
    ) {
        $this-&gt;db            = $db;
        $this-&gt;hydrator      = $hydrator;
        $this-&gt;postPrototype = $postPrototype;
    }

    /**
     * Return a set of all blog posts that we can iterate over.
     *
     * Each entry should be a Post instance.
     *
     * @return Post[]
     */
    public function findAllPosts()
    {
        $sql       = new Sql($this-&gt;db);
        $select    = $sql-&gt;select('posts');
        $statement = $sql-&gt;prepareStatementForSqlObject($select);
        $result    = $statement-&gt;execute();

        if (! $result instanceof ResultInterface || ! $result-&gt;isQueryResult()) {
            return [];
        }

        $resultSet = new HydratingResultSet($this-&gt;hydrator, $this-&gt;postPrototype);
        $resultSet-&gt;initialize($result);
        return $resultSet;
    }

    /**
     * Return a single blog post.
     *
     * @param  int $id Identifier of the post to return.
     * @return Post
     */
    public function findPost($id)
    {
    }
}</code></pre>

<p>Now that our repository requires more parameters, we need to update the
<code>ZendDbSqlRepositoryFactory</code> and inject those parameters:</p>
<pre class="codehilite"><code class="language-php">// In /module/Blog/src/Factory/ZendDbSqlRepositoryFactory.php
namespace Blog\Factory;

use Interop\Container\ContainerInterface;
use Blog\Model\Post;
use Blog\Model\ZendDbSqlRepository;
use Zend\Db\Adapter\AdapterInterface;
use Zend\Hydrator\Reflection as ReflectionHydrator;
use Zend\ServiceManager\Factory\FactoryInterface;

class ZendDbSqlRepositoryFactory implements FactoryInterface
{
    public function __invoke(ContainerInterface $container, $requestedName, array $options = null)
    {
        return new ZendDbSqlRepository(
            $container-&gt;get(AdapterInterface::class),
            new ReflectionHydrator(),
            new Post('', '')
        );
    }
}</code></pre>

<p>With this in place you can refresh the application again and you'll see your
blog posts listed once again. Our repository no longer has hidden dependencies,
and works with a database!</p>
<h2 id="finishing-the-repository">Finishing the repository</h2>
<p>Before we jump into the next chapter, let's quickly finish the repository
implementation by completing the <code>findPost()</code> method:</p>
<pre class="codehilite"><code class="language-php">public function findPost($id)
{
    $sql       = new Sql($this-&gt;db);
    $select    = $sql-&gt;select('posts');
    $select-&gt;where(['id = ?' =&gt; $id]);

    $statement = $sql-&gt;prepareStatementForSqlObject($select);
    $result    = $statement-&gt;execute();

    if (! $result instanceof ResultInterface || ! $result-&gt;isQueryResult()) {
        throw new RuntimeException(sprintf(
            'Failed retrieving blog post with identifier &quot;%s&quot;; unknown database error.',
            $id
        ));
    }

    $resultSet = new HydratingResultSet($this-&gt;hydrator, $this-&gt;postPrototype);
    $resultSet-&gt;initialize($result);
    $post = $resultSet-&gt;current();

    if (! $post) {
        throw new InvalidArgumentException(sprintf(
            'Blog post with identifier &quot;%s&quot; not found.',
            $id
        ));
    }

    return $post;
}</code></pre>

<p>The <code>findPost()</code> function looks similar to the <code>findAllPosts()</code> method, with
several differences.</p>
<ul>
<li>We need to add a condition to the query to select only the row matching the
  provided identifier; this is done using the <code>where()</code> method of the <code>Sql</code>
  object.</li>
<li>We check if the <code>$result</code> is valid, using <code>isQueryResult()</code>; if not, an error
  occurred during the query that we report via a <code>RuntimeException</code>.</li>
<li>We pull the <code>current()</code> item off the result set we create, and test to make
  sure we received something; if not, we had an invalid identifier, and raise an
  <code>InvalidArgumentException</code>.</li>
</ul>
<h2 id="conclusion">Conclusion</h2>
<p>Finishing this chapter, you now know how to <em>query</em> for data using the
<code>Zend\Db\Sql</code> classes. You have also learned a little about the zend-hydrator
component, and the integration zend-db provides with it.  Furthermore, we've
continued demonstrating dependency injection in all aspects of our application.</p>
<p>In the next chapter we'll take a closer look at the router so we'll be able to
start displaying individual blog posts.</p>



    <nav>
    <ul class="page-nav hidden-print">

        
        <li class="page-nav__item">
            
                <a rel="prev" class="page-nav__link page-nav__link--prev" href="../preparing-databases/">
                    <i class="fa fa-chevron-left"></i> Previous
                </a>
            
        </li>

        
        <li class="page-nav__item">
            
                <a rel="next" class="page-nav__link page-nav__link--next" href="../understanding-routing/">
                    Next <i class="fa fa-chevron-right"></i>
                </a>
            
        </li>
    </ul>
</nav>


<div class="help-wanted">
    <p>
        Found a mistake or want to contribute to the documentation?
        <a href="https://github.com/zendframework/tutorials/edit/master/docs/in-depth-guide/zend-db-sql-zend-hydrator.md" target="_blank" class="help-wanted__link">
            Edit this page on GitHub!
        </a>
    </p>
</div>
                
            <!-- content:end -->
            </div>
            <div class="col-md-3 col-xs-12 sidebar">
                
                    <div class="component-selector">
    <h4 class="component-selector__title">Components</h4>
    <h5 class="component-selector__subtitle">Find documentation…</h5>
    <select class="form-control component-selector__control">
        <option value="/">Overview</option>
        <optgroup label="Components"></optgroup>
    </select>
</div>
                    <div class="subnavigation hidden-print">
    <h4 class="subnavigation__title">
        <a href="../..">tutorials</a>
    </h4>

    <h5 class="subnavigation__subtitle">Table of Contents</h5>

    <ul class="subnavigation__list">
        
            
                <li class="subnavigation__list-item ">
                    <a href="../.." class="subnavigation__link">Tutorials for Zend Framework</a>
                </li>
            
        
            
                <li class="subnavigation__list-item">
                    <span class="subnavigation__headline">MVC Tutorials</span>
                    <ul class="subnavigation__list">
                        
                            
    <li class="subnavigation__list-item">
        <span class="subnavigation__headline">Getting Started with Zend Framework</span>
        <ul class="subnavigation__list">
            
                
    <li class="subnavigation__list-item ">
        <a href="../../getting-started/overview/" class="subnavigation__link">Overview</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../../getting-started/skeleton-application/" class="subnavigation__link">The Skeleton Application</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../../getting-started/modules/" class="subnavigation__link">Modules</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../../getting-started/routing-and-controllers/" class="subnavigation__link">Routing and Controllers</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../../getting-started/database-and-models/" class="subnavigation__link">Database and Models</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../../getting-started/forms-and-actions/" class="subnavigation__link">Forms and Actions</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../../getting-started/conclusion/" class="subnavigation__link">Conclusion</a>
    </li>

            
        </ul>
    </li>

                        
                            
    <li class="subnavigation__list-item ">
        <a href="../../unit-testing/" class="subnavigation__link">Unit Testing A zend-mvc Application</a>
    </li>

                        
                            
    <li class="subnavigation__list-item ">
        <a href="../../navigation/" class="subnavigation__link">Adding zend-navigation to the Album Module</a>
    </li>

                        
                            
    <li class="subnavigation__list-item ">
        <a href="../../pagination/" class="subnavigation__link">Adding zend-paginator to the Album Module</a>
    </li>

                        
                            
    <li class="subnavigation__list-item">
        <span class="subnavigation__headline">In-Depth Tutorial</span>
        <ul class="subnavigation__list">
            
                
    <li class="subnavigation__list-item ">
        <a href="../first-module/" class="subnavigation__link">Introducing the Blog Module</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../models-and-servicemanager/" class="subnavigation__link">Models and the ServiceManager</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../preparing-databases/" class="subnavigation__link">Preparing for Different Databases</a>
    </li>

            
                
    <li class="subnavigation__list-item subnavigation__list-item--active">
        <a href="./" class="subnavigation__link">SQL Abstraction and Object Hydration</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../understanding-routing/" class="subnavigation__link">Understanding the Router</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../zend-form-zend-form-fieldset/" class="subnavigation__link">Making Use of Forms and Fieldsets</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../data-binding/" class="subnavigation__link">Editing and Deleting Data</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../review/" class="subnavigation__link">Reviewing the Blog Module</a>
    </li>

            
        </ul>
    </li>

                        
                            
    <li class="subnavigation__list-item ">
        <a href="../../advanced-config/" class="subnavigation__link">Advanced Configuration</a>
    </li>

                        
                            
    <li class="subnavigation__list-item ">
        <a href="../../i18n/" class="subnavigation__link">Internationalization</a>
    </li>

                        
                    </ul>
                </li>
            
        
            
                <li class="subnavigation__list-item">
                    <span class="subnavigation__headline">Component Tutorials</span>
                    <ul class="subnavigation__list">
                        
                            
    <li class="subnavigation__list-item ">
        <a href="../../db-adapter/" class="subnavigation__link">Setting Up A Database Adapter</a>
    </li>

                        
                            
    <li class="subnavigation__list-item ">
        <a href="../../event-manager/" class="subnavigation__link">Using the EventManager</a>
    </li>

                        
                    </ul>
                </li>
            
        
            
                <li class="subnavigation__list-item">
                    <span class="subnavigation__headline">Migration</span>
                    <ul class="subnavigation__list">
                        
                            
    <li class="subnavigation__list-item">
        <span class="subnavigation__headline">To Version 3</span>
        <ul class="subnavigation__list">
            
                
    <li class="subnavigation__list-item ">
        <a href="../../migration/to-v3/overview/" class="subnavigation__link">Overview</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../../migration/to-v3/components/" class="subnavigation__link">Components</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../../migration/to-v3/application/" class="subnavigation__link">Applications</a>
    </li>

            
        </ul>
    </li>

                        
                    </ul>
                </li>
            
        
    </ul>
</div>
                
            </div>
        </div>
    </div>

    
    <footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-9">
                <h5>Zend Framework</h5>
                <ul>
                    <li><a href="https://framework.zend.com/">framework.zend.com</a></li>
                    <li><a href="https://docs.zendframework.com">docs.zendframework.com</a></li>
                    <li><a href="https://packages.zendframework.com">packages.zendframework.com</a></li>
                    <li><a href="https://apigility.org">apigility.org</a></li>
                    <li><a href="https://getexpressive.org/">getexpressive.org</a></li>
                </ul>
            </div>
        </div>

        
        <div class="row">
            <div class="col-md-12 text-center">
                <a class="footer__button" href="#page-top"><i class="fa fa-chevron-up" aria-hidden="true"></i></a>
            </div>
        </div>

        <div class="row">

            
            <div class="col-md-9">
                <h4 class="footer__headline">Copyright</h4>
                <p>&copy; 2006-2018 by <a href="https://www.zend.com/">Zend</a>, a <a href="https://www.roguewave.com/">Rogue Wave Company</a>.</p>
            </div>

            
            <div class="col-md-3">
                <h4 class="footer__headline">Support</h4>
                <ul class="support__list">
                    <li class="support__list-item">
                        <a href="https://discourse.zendframework.com" class="support__link" title="Forum"><i class="fa fa-comments"></i></a>
                    </li>
                    <li class="support__list-item">
                        <a href="https://zendframework-slack.herokuapp.com" class="support__link" title="Chat"><i class="fa fa-slack"></i></a>
                    </li>
                    <li class="support__list-item">
                        <a href="https://github.com/zendframework" class="support__link" title="Github"><i class="fa fa-github"></i></a>
                    </li>
                    <li class="support__list-item">
                        <a href="https://twitter.com/zfdevteam" class="support__link" title="Twitter"><i class="fa fa-twitter"></i></a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</footer>

    <script>
        var base_url = '../..',
            siteName = 'tutorials';
    </script>
    <script src="../../js/scripts-dcbafde59f.js"></script>
        <script src="../../search/require.js"></script>
        <script src="../../search/search.js"></script>

    
    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                </div>
                <div class="modal-body">
                    <p>
                        From here you can search these documents. Enter your search terms below.
                    </p>
                    <form role="form">
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                        </div>
                    </form>
                    <div id="mkdocs-search-results"></div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>



</body>


</html>
